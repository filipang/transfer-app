<!DOCTYPE html>
{% load static %}
{% load bootstrap4 %}
{% load i18n %}
{% load notifications_tags %}

{% get_current_language as language_code %}
<html lang="{{ language_code }}">
    <head>
        <meta charset="UTF-8">
        <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
        <title>Free transfer</title>

        <link rel="icon" href="{% static 'favicon.ico' %}">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

        <link href="{% static 'css/styles.css' %}" rel="stylesheet">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
    </head>
    <body>
        {% if request.user.is_authenticated %}
        <div class="wrapper">
            <nav id="sidebar" class = "active">
                <ul class="list-unstyled">
                    <li>
                        <a href="#pageSubmenu" data-toggle="collapse" aria-expanded="false">Friend Requests ({{ friend_request_users|length }})</a>
                        <div class="small_space_down"></div>
                        <ul class="collapse list-unstyled" id="pageSubmenu">
                            {% for user in friend_request_users %}
                                <li class="small_space_down sidebar_margin" username_req="{{ user.username }}">
                                    <img class="profile_img_req"  src="{{user.profileimage.image.url}}" alt="Profile Image">
                                    <a class="inline" href="">{{ user.username }}</a>
                                    <button href="" class="inline small_button button_request_no" username_btn="{{ user.username }}">Nay</button>
                                    <button class="inline small_button button_request_yes" username_btn="{{ user.username }}">Yay</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                    <div style="height:70px;position:relative">
                        <h5 style="margin-top:0px;margin-bottom:0px; position: absolute;left: .5em;top: 50%;transform: translate(0,-50%);" class="inline sidebar_margin">Notifications ({% live_notify_badge %})</h5>
                        <button style="color:black;  position: absolute;right: 1em;top: 50%;transform: translate(0,-50%);" class="inline clear_btn">Clear</button>
                    </div>
                    <div class="sidebar_margin">
                    {% live_notify_list %}
                    </div>
                    <li>
                        <div style="height:70px;position:relative" class="sidebar-header">
                            <h5 style="margin-top:0px;margin-bottom:0px; position: absolute;left: 1em;top: 50%;transform: translate(0,-50%);" class="inline">Friend list ({{ friends|length }})</h5>
                            <a style="position: absolute;right: 1em;top: 50%;transform: translate(0,-50%);font-size:1em;" class="inline" href="{% url 'accounts:search' %}">Search users...</a>
                        </div>
                    </li>
                </ul>
                <div class="sidebar_margin sidebar_searchbar">
                    <input class="form-control" id="listSearch" type="text" placeholder="Search friend...">
                </div>
                <ul class="list-unstyled list-group sidebar_margin" id = "friendList">
                    {% for friend in friends %}
                        <li class="dropdown small_space_down" username_friend="{{ friend.username }}">
                            <img class="profile_img_friend"  src="{{friend.profileimage.image.url}}" alt="Profile Image">
                            <a class="dropdown-toggle inline" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                {{ friend.username }}
                            </a>

                            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                <a class="dropdown-item" href="{% url 'accounts:profile' friend.username %}">View profile</a>
                                <a class="dropdown-item" href="{% url 'transfers:live_transfer' friend.username %}">Send files...</a>
                                <a username_value = "{{friend.username}}" class="dropdown-item remove_friend_btn" href="">Remove Friend</a>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </nav>
            <div id="content" class = "active">
                {% endif %}
                <nav class="navbar navbar-default bg-primary">
                    <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <img class="navbar-brand bg-secondary nopadding margin5" src="{% static 'free-transfer-logo.png' %}"></img>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <ul class="nav navbar-nav navbar-right">
                                <li class="navbar-text-style {% if request.resolver_match.url_name == 'upload' %} active {% endif %}"><a class="padding20" href="{% url 'transfers:upload' %}">Home<span class="sr-only">(current)</span></a></li>
                                <li class="navbar-text-style {% if request.resolver_match.url_name == 'live_transfer' or request.resolver_match.url_name == 'live_transfer_link' or request.resolver_match.url_name == 'live_transfer_download'  %} active {% endif %}"><a class="padding20" href="{% url 'transfers:live_transfer_link' %}">Live Transfer<span class="sr-only">(current)</span></a></li>
                                {% if request.user.is_authenticated %}
                                <li class="navbar-text-style {% if request.resolver_match.url_name == 'profile' %} active {% endif %}"><a class="padding20" href="{% url 'accounts:profile' request.user.get_username %}">My profile</a></li>
                                <li class="dropdown navbar-text-style">
                                    <a href="#" class="dropdown-toggle padding20 {% if request.resolver_match.url_name == 'change_password' or request.resolver_match.url_name == 'change_email' or request.resolver_match.url_name == 'change_profile' %} active {% endif %}" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Account <span class="caret"></span></a>
                                    <ul class="dropdown-menu bg-primary">
                                        <li><a href="{% url 'accounts:log_out' %}">Log out</a></li>
                                        <li role="separator" class="divider"></li>
                                        <li><a href="{% url 'accounts:change_email' %}">Change email</a></li>
                                        <li role="separator" class="divider"></li>
                                        <li><a href="{% url 'accounts:change_password' %}" >Change password</a></li>
                                        <li role="separator" class="divider"></li>
                                        <li><a href="{% url 'accounts:change_profile' %}">Change profile details</a></li>
                                        <li role="separator" class="divider"></li>
                                        <li><a href="{% url 'accounts:change_image' %}">Change profile image</a></li>
                                    </ul>
                                </li>
                                <li class="dropdown navbar-text-style">
                                    <a href="#" class="dropdown-toggle padding20" type="button" id="sidebarCollapse">Social({% live_notify_badge %})
                                        <i class="fas fa-align-left"></i>
                                        <span class="sr-only">(current)</span>
                                    </a>
                                </li>
                                {% else %}
                                <li class="navbar-text-style"><a class="padding20" href="{% url 'accounts:log_in' %}">Log in</a></li>
                                <li class="navbar-text-style"><a class="padding20" href="{% url 'accounts:sign_up' %}">Sign up</a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </nav>
                <div class="container-fluid mt-3">

                    {% bootstrap_messages %}

                    {% block content %}
                        No content.
                    {% endblock %}

                </div>
                {% if request.user.is_authenticated %}
            </div>
        </div>
            {% endif %}
        <script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
        {% register_notify_callbacks callbacks='fill_notification_list,fill_notification_badge' %}
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="{% static 'vendor/popper/popper.min.js' %}"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script src="{% static 'js/ie10-viewport-bug-workaround.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                $("#sidebar").mCustomScrollbar({
                    theme: "minimal"
                });

                $('#sidebarCollapse').on('click', function () {
                    $('#sidebar, #content').toggleClass('active');
                    $('.collapse.in').toggleClass('in');
                    $('a[aria-expanded=true]').attr('aria-expanded', 'false');
                });

                  $("#listSearch").on("keyup", function() {
                    var value = $(this).val().toLowerCase();
                    $("#friendList li").filter(function() {
                      $(this).toggle($(this).attr('username_friend').toLowerCase().indexOf(value) > -1)
                    });
                  });


                $('.button_request_yes').on('click',function(e){
                    $.ajax({
                        type:'POST',
                        url:'accept_friend/' + $(this).attr('username_btn'),
                        data:{
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success:function(json){
                            $("li[username_req='" + json.username + "']").remove();

                        },
                        error : function(xhr,errmsg,err) {
                        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                        },

                    });
                });

                 $('.clear_btn').on('click',function(e){
                    $.ajax({
                        type:'POST',
                        url:'{% url 'accounts:clear_notifications' %}',
                        data:{
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success:function(json){
                            $("li[username_req='" + json.username + "']").remove();

                        },
                        error : function(xhr,errmsg,err) {
                        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                        },

                    });
                });

                $('.remove_friend_btn').on("click", function(){
                   $.ajax({
                        type:'POST',
                        url:'/remove_friend/' + $(this).attr('username_value'),
                        data:{
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success:function(json){
                            $("li[username_req='" + json.username + "']").remove();

                        },
                        error : function(xhr,errmsg,err) {
                        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                        },

                    });
                });
            });
        </script>
    </body>
</html>
